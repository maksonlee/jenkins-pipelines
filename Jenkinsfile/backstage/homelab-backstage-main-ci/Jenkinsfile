pipeline {
    agent { label 'ssh-agent-with-docker' }

    triggers {
        githubPush()
    }

    environment {
        DOCKER_BUILDKIT = '1'
        HARBOR_REGISTRY = 'harbor.maksonlee.com'
        HARBOR_PROJECT = 'backstage'
        IMAGE_NAME = 'homelab-backstage'
    }

    stages {
        stage('Fetch code') {
            steps {
                deleteDir()
                git credentialsId: 'vault-github-ssh',
                        url: 'git@github.com:maksonlee/homelab-backstage.git',
                        branch: 'main'
            }
        }

        stage('Build') {
            steps {
                sh '''#!/usr/bin/env bash
                    set -euo pipefail
                    TAG="$(git rev-parse --short=7 HEAD)"
                    IMAGE_SHA="${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:${TAG}"
                    IMAGE_TEST="${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:test"

                    docker build -f Dockerfile.multi -t "$IMAGE_SHA" -t "$IMAGE_TEST" .
                '''
            }
        }

        stage('Push to Harbor') {
            steps {
                withCredentials([usernamePassword(
                        credentialsId: 'harbor-system-robot',
                        usernameVariable: 'HARBOR_USER',
                        passwordVariable: 'HARBOR_PASS'
                )]) {
                    sh '''#!/usr/bin/env bash
                        set -euo pipefail
                        TAG="$(git rev-parse --short=7 HEAD)"
                        IMAGE_SHA="${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:${TAG}"
                        IMAGE_TEST="${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:test"

                        echo "$HARBOR_PASS" | docker login "$HARBOR_REGISTRY" -u "$HARBOR_USER" --password-stdin
                        docker push "$IMAGE_SHA"
                        docker push "$IMAGE_TEST"
                        docker logout "$HARBOR_REGISTRY"
                    '''
                }
            }
        }
    }

    post {
        always {
            cleanWs(deleteDirs: true, notFailBuild: true)
        }
    }
}
